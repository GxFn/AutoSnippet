# 按场景/语言/模块的个性化推荐 - 实现计划

检索与推荐时，结合用户当前场景（如正在写网络请求）、语言（objc/swift）、模块（target），优先返回更相关的 Recipe，提升「即搜即用」的准确性。

---

## 一、目标与价值

| 目标 | 价值 |
|------|------|
| **场景过滤** | 按 category（network、video、ui 等）缩小检索范围，避免无关 Recipe 干扰 |
| **语言偏好** | 仅返回 objc 或 swift，避免混语言时插入错误形态的代码 |
| **模块关联** | 按当前编辑文件所属 SPM target 优先推荐同模块 Recipe，依赖更贴近 |
| **排序增强** | 在权威分基础上对「匹配 filter 的项」加分，提升相关性 |

---

## 二、现状分析

### 2.1 数据层：metadata 写入

**索引管道**（`lib/context/IndexingPipeline.js`）：

- 扫描 Recipe 时使用 `stripFrontmatter(content)`，**丢弃 frontmatter**，仅将正文分块
- 传入 chunker 的 metadata：`{ sourcePath, type, sourceHash, updatedAt }`，**无 category、language、module**
- `createItemMetadata`（`lib/context/constants.js`）支持 `category`、`language`、`module`，但 IndexingPipeline 从未传入

**结论**：当前索引的 metadata **不含** category、language、module，无法按这些维度过滤。

### 2.2 检索层：filter 支持

| 模块 | 支持的 filter | 说明 |
|------|---------------|------|
| **JsonAdapter** | type, sourcePath, category, module, language, deprecated, tags | 完整支持 |
| **LanceAdapter** | type, sourcePath | **_buildWhere 仅实现 type/sourcePath**，需扩展 |
| **ContextService.search** | 透传 options.filter | 已支持 |
| **searchService.semanticSearch** | 硬编码 `filter: { type: 'recipe' }` | **未接受外部 filter** |
| **/api/context/search** | 接受 body.filter | 已支持 |

### 2.3 调用链：上下文来源

| 入口 | 当前行为 | 可获取的上下文 |
|------|----------|----------------|
| **// as:search** | `searchService.search(projectRoot, keyword, { semantic: true, limit: 8 })`，无 filter | fullPath、relativePath → 可推断 language（.m/.h=objc, .swift=swift）、module（moduleResolver） |
| **MCP autosnippet_context_search** | 仅 `query`、`limit`，无 filter 参数 | Cursor 可传入当前文件路径或用户意图 |
| **Dashboard 检索** | Header 搜索调用 `/api/search/semantic`，仅 keyword、limit | 用户可勾选语言、category |
| **asd search** | CLI，无文件上下文 | 可增加 `--language`、`--category` 参数 |

### 2.4 已有能力

- **defaults.inferCategory(relPath, content)**：从路径或 frontmatter 推断 category，**未被 IndexingPipeline 使用**
- **parseRecipeMd**：可解析 frontmatter 的 category、language
- **moduleResolver.determineCurrentModuleName(filePath, packageInfo)**：从文件路径 + Package.swift 推断 target 名

---

## 三、技术方案

### 3.1 P0：索引时写入 metadata（category、language、module）

**修改** `lib/context/IndexingPipeline.js` 的 scan 阶段：

1. 对 Recipe 类型文件，**不再 stripFrontmatter 后丢弃**，先用 `parseRecipeMd` 或 `parseFrontmatter` 解析
2. 从 frontmatter 提取：`category`、`language`（若无则从代码块语言推断）
3. module 推断：Recipe 路径 `Knowledge/recipes/xxx.md` 难以直接对应 SPM target；可选方案：
   - **方案 A**：从 Recipe 路径或 frontmatter 约定 `module` 字段（需 Recipe 作者填写）
   - **方案 B**：暂不写入 module，仅 category、language；module 由**调用方**根据当前文件推断后作为 filter 传入（检索时过滤 sourcePath 含某 target 的 Recipe，需建立 Recipe↔target 映射，较复杂）
   - **建议**：P0 先实现 category、language；module 作为 P2 增强

4. 将 `category`、`language` 传入 `chunker.chunk` 的 baseMetadata，最终进入 `createItemMetadata`

**验收**：执行 `asd embed --clear` 后，检查 `vector_index.json` 或 LanceDB 中 Recipe 条目的 metadata 含 `category`、`language`。

### 3.2 P1：检索 API 与 searchService 透传 filter

**修改** `lib/search/searchService.js`：

```javascript
// semanticSearch 增加 options.filter
async function semanticSearch(projectRoot, keyword, limit = 5, filter = {}) {
  const baseFilter = { type: 'recipe', ...filter };
  const items = await service.search(keyword, { limit, filter: baseFilter });
  // ...
}
```

**修改** `bin/ui.js` 的 `/api/context/search`：

- 已接受 `filter`，确保前端/MCP 传入的 `language`、`category` 原样透传给 `service.search`

**修改** `bin/ui.js` 的 `/api/search/semantic`：

- 请求体增加 `filter: { language?, category? }`，透传给 searchService

**修改** `lib/context/adapters/LanceAdapter.js` 的 `_buildWhere`：

- 增加 `category`、`language`、`module` 的 where 条件（与 JsonAdapter 对齐）

**验收**：调用 `/api/context/search` 并传入 `filter: { language: 'swift' }`，仅返回 language=swift 的 Recipe。

### 3.3 P2：MCP autosnippet_context_search 增加 filter 参数

**修改** `scripts/mcp-server.js`：

- `autosnippet_context_search` 的 inputSchema 增加可选参数：
  - `language?: string`（'objc' | 'swift'）
  - `category?: string`（'network' | 'video' | 'ui' | ...）
  - `module?: string`（SPM target 名，可选）
- 调用 `postContextSearch` 时传入 filter

**验收**：Cursor 调用工具时传入 `language: 'swift'`，返回结果仅含 Swift Recipe。

### 3.4 P3：// as:search 上下文感知

**修改** `lib/watch/fileWatcher.js` 的 `handleSearchTrigger`：

1. 从 `fullPath` 推断：
   - **language**：`.m`/`.h` → `objc`，`.swift` → `swift`
   - **module**：调用 `moduleResolver.determineCurrentModuleName(fullPath, packageInfo)`（需先 `packageParser.findPackageSwiftPath` + `parsePackageSwift`）
2. 调用 `searchService.search` 时传入 `filter: { language, module }`（module 若建立映射则传，否则可选）
3. **searchService.search** 需支持 `options.filter`，并传给 `semanticSearch`

**验收**：在 `.swift` 文件中写 `// as:search 请求` 保存，检索结果优先为 Swift Recipe。

### 3.5 P4：排序增强 sceneBoost（可选）

**修改** `bin/ui.js` 的 `/api/context/search` 返回前处理：

- 对 `items` 中 `metadata` 与 `filter` 匹配的项，在 `stats.authorityScore` 基础上加 `sceneBoost`（如 +0.1）
- 按 `authorityScore + sceneBoost` 重排后再返回

**验收**：filter 匹配的 Recipe 在结果中更靠前。

---

## 四、实现阶段与依赖

| 阶段 | 内容 | 产出 | 依赖 |
|------|------|------|------|
| **P0** | IndexingPipeline 解析 Recipe frontmatter，写入 category、language | metadata 含 category/language；LanceAdapter _buildWhere 扩展 | 无 |
| **P1** | searchService、API 透传 filter；LanceAdapter 支持 category/language | 检索可按语言、category 过滤 | P0 |
| **P2** | MCP autosnippet_context_search 增加 filter 参数 | Cursor 可传入语言、category | P1 |
| **P3** | watch handleSearchTrigger 推断 language/module，传给 search | as:search 场景相关 | P1 |
| **P4** | sceneBoost 排序增强 | 匹配项优先 | P1 |

**建议顺序**：P0 → P1 → P2 与 P3 并行 → P4。

---

## 五、配置与扩展

### 5.1 category 枚举

与 `dashboard/src/constants` 的 `categories` 对齐，建议支持：

`network`、`video`、`navigation`、`foundation`、`ui`、`View`、`Service`、`Tool`、`Model`、`Storage`、`Utility` 等。`defaults.inferCategory` 已含路径匹配规则，可复用。

### 5.2 language 归一化

- 用户/前端可能传入：`objc`、`oc`、`objectivec`、`swift`
- 索引与过滤前统一为：`objc`、`swift`（与 parseRecipeMd 输出一致）

### 5.3 module 与 Recipe 映射（P2 可选）

若需按 SPM target 过滤 Recipe，需建立「Recipe ↔ target」映射：

- **选项 A**：Recipe frontmatter 增加 `module: BDNetworkControl`，由作者维护
- **选项 B**：根据 Recipe 中 headers 引用的头文件，反查所属 target（依赖 SPM 解析，较复杂）

---

## 六、测试与验证

| 场景 | 验证方式 |
|------|----------|
| metadata 写入 | `asd embed --clear` 后检查索引 JSON/LanceDB，确认 category、language |
| filter 过滤 | 调用 API 传入 filter，断言返回项 metadata 匹配 |
| as:search 语言 | 在 .swift 与 .m 文件中分别 as:search，对比结果语言分布 |
| MCP filter | Cursor 调用工具传 language，检查返回 |

---

## 七、相关文档

- [权威评分系统与数据格式](./权威评分系统与数据格式.md)：authorityScore 与 sceneBoost 的关系
- [context 配置说明](./context配置说明.md)：索引与存储
- [使用文档](./使用文档.md)：as:search、MCP 使用
- [MCP 配置说明](./MCP配置说明.md)：工具配置
