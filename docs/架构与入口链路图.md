# AutoSnippet V2 架构与入口链路图

**版本**：v2.0.0  
**日期**：2026-06  

---

## 1. 系统架构全景

```
┌────────────────────────────────────────────────────────────────────┐
│                         应用层 (Application)                       │
│                                                                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐  │
│  │ CLI (asd)│  │MCP Server│  │ HTTP API │  │  Dashboard (Web) │  │
│  │ 10 命令  │  │ 31 工具  │  │ 91 端点  │  │  React 19 + Vite │  │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────────┬─────────┘  │
│       │              │              │                  │            │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │                     Skills (10 个)                          │   │
│  │  intent │ concepts │ candidates │ recipes │ guard │ ...    │   │
│  └────────────────────────────────────────────────────────────┘   │
└────────┼──────────────┼──────────────┼──────────────┼─────────────┘
         │              │              │              │
         ▼              ▼              ▼              ▼
┌────────────────────────────────────────────────────────────────────┐
│                      控制平面 (Control Plane)                       │
│                                                                    │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │                    Gateway (324 行)                         │   │
│  │  validate → permission → constitution → plugin → dispatch  │   │
│  └────────────────────────┬───────────────────────────────────┘   │
│        ┌─────────────┬────┴─────┬─────────────┬───────────┐      │
│  ┌─────┴─────┐ ┌─────┴────┐ ┌──┴───────┐ ┌───┴───┐ ┌────┴──┐  │
│  │ Permission│ │Constitut.│ │ Session  │ │ Audit │ │Capab. │  │
│  │  Manager  │ │Validator │ │ Manager  │ │Logger │ │ Probe │  │
│  │  (249行)  │ │  (260行) │ │ (233行)  │ │(111行)│ │(248行)│  │
│  └───────────┘ └──────────┘ └──────────┘ └───────┘ └───────┘  │
└────────────────────────────────┬───────────────────────────────────┘
                                 │
                                 ▼
┌────────────────────────────────────────────────────────────────────┐
│                       服务层 (Service Layer)                        │
│                                                                    │
│  ┌─────────────────────────────────────────────────────────┐      │
│  │          ChatAgent (31 工具 + 5 任务)                    │      │
│  │  统一 AI 入口 ── 所有业务级 AI 调用经此路由              │      │
│  │  ReAct 循环(6轮) / executeTool / runTask                │      │
│  └──────────────────────┬──────────────────────────────────┘      │
│                         │                                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐             │
│  │Candidate │ │  Recipe  │ │  Search  │ │  Guard   │             │
│  │ Service  │ │ Service  │ │  Engine  │ │  Check   │             │
│  │ (434行)  │ │+ Writer  │ │ (432行)  │ │ (346行)  │             │
│  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘             │
│       │             │             │             │                   │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐             │
│  │Knowledge │ │   SPM    │ │ AiProvide│ │ Quality  │             │
│  │  Graph   │ │ Service  │ │(embed 专用)│ │  Scorer  │             │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘             │
└────────────────────────────────┬───────────────────────────────────┘
                                 │
                                 ▼
┌────────────────────────────────────────────────────────────────────┐
│                        数据层 (Data Layer)                          │
│                                                                    │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────────────┐     │
│  │   SQLite DB  │  │ Vector Store │  │  Recipe .md Files   │     │
│  │ (索引/缓存)  │  │ (JSON/Milvus)│  │ (Source of Truth)   │     │
│  │  10 migrations│  │  1536 dims   │  │  YAML + Markdown    │     │
│  └──────────────┘  └──────────────┘  └─────────────────────┘     │
└────────────────────────────────────────────────────────────────────┘
```

---

## 2. 入口链路详解

### 2.1 CLI 链路

```
┌─────────────────────────────────────────────────────────────────┐
│ 用户终端                                                        │
│                                                                  │
│  $ asd <command> [args]                                         │
│                                                                  │
│  ┌──────────────────────────┐                                   │
│  │ bin/cli.js (Commander)   │                                   │
│  │                          │                                   │
│  │  setup ──┐               │                                   │
│  │  search ─┤               │                                   │
│  │  guard ──┤               │                                   │
│  │  watch ──┤               │                                   │
│  │  compliance ─┤ → Bootstrap.init(projectDir)                  │
│  │  server ─┤       ↓                                           │
│  │  ui ─────┤     ServiceContainer.build()                      │
│  │  status ─┤       ↓                                           │
│  │  upgrade ┤     services.<method>(args)                       │
│  │  sync ───┘                                                   │
│  │                          │                                   │
│  └──────────────────────────┘                                   │
└─────────────────────────────────────────────────────────────────┘
```

**关键 CLI 工作流**：

| 命令 | 服务调用链 |
|------|-----------|
| `asd setup` | Bootstrap → SetupService.setup() → SyncService (if existing .md files) |
| `asd search <q>` | Bootstrap → SearchEngine.search(q) → BM25 + keyword + semantic |
| `asd guard <f>` | Bootstrap → GuardCheckEngine.auditFile(f) → built-in + custom rules |
| `asd compliance` | Bootstrap → ComplianceEvaluator.evaluate() → P1-P4 scoring |
| `asd sync` | Bootstrap → SyncService.sync() → .md parse → hash verify → DB upsert |
| `asd ui` | Bootstrap → HttpServer + Vite(dashboard/) + FileWatcher |

### 2.2 MCP Server 链路

```
┌─────────────────────────────────────────────────────────────────┐
│ IDE (Cursor / VS Code Copilot)                                  │
│                                                                  │
│  Agent 调用 MCP 工具                                             │
│       │                                                          │
│       ▼ (stdio)                                                  │
│  ┌──────────────────────────┐                                   │
│  │ bin/mcp-server.js        │                                   │
│  │                          │                                   │
│  │  McpServer               │                                   │
│  │   .setRequestHandler()   │                                   │
│  │       │                  │                                   │
│  │       ▼                  │                                   │
│  │  tools/call 路由         │                                   │
│  │       │                  │                                   │
│  │       ├─ read ops ───── handler(args, services) ── result   │
│  │       │                  │                                   │
│  │       └─ write ops ──── TOOL_GATEWAY_MAP                    │
│  │                  │       │                                   │
│  │                  ▼       │                                   │
│  │           Gateway.execute()                                  │
│  │           permission + constitution + audit                  │
│  │                  │       │                                   │
│  │                  ▼       │                                   │
│  │           handler(args, services) ── result                 │
│  └──────────────────────────┘                                   │
└─────────────────────────────────────────────────────────────────┘
```

**Gateway 保护的 MCP 工具（7 个写操作）**：

| MCP 工具 | Gateway Action |
|----------|---------------|
| `submit_candidate` | `candidate:create` |
| `submit_candidates` | `candidate:create` |
| `submit_draft_recipes` | `recipe:create` |
| `enrich_candidates` | `candidate:create` |
| `guard_check` | `guard_rule:check_code` |
| `guard_audit_files` | `guard_rule:check_code` |
| `scan_project` | `guard_rule:check_code` |

### 2.3 HTTP API 链路

```
┌─────────────────────────────────────────────────────────────────┐
│ Dashboard / 外部客户端                                           │
│                                                                  │
│  HTTP Request                                                    │
│       │                                                          │
│       ▼                                                          │
│  ┌──────────────────────────┐                                   │
│  │ bin/api-server.js        │                                   │
│  │                          │                                   │
│  │  Express App             │                                   │
│  │   ├── cors + helmet      │                                   │
│  │   ├── JSON body parser   │                                   │
│  │   │                      │                                   │
│  │   ├── /api/health        │ → health.js (2 端点)              │
│  │   ├── /api/auth          │ → auth.js (3 端点)                │
│  │   ├── /api/candidates    │ → candidates.js (14 端点)         │
│  │   ├── /api/recipes       │ → recipes.js (13 端点)            │
│  │   ├── /api/guard-rules   │ → guardRules.js (10 端点)         │
│  │   ├── /api/search        │ → search.js (7 端点)              │
│  │   ├── /api/snippets      │ → snippets.js (6 端点)            │
│  │   ├── /api/ai            │ → ai.js (7 端点)                  │
│  │   ├── /api/extract       │ → extract.js (2 端点)             │
│  │   ├── /api/commands      │ → commands.js (8 端点)            │
│  │   ├── /api/spm           │ → spm.js (5 端点)                 │
│  │   ├── /api/violations    │ → violations.js (4 端点)          │
│  │   └── /api/monitoring    │ → monitoring.js (9 端点)          │
│  │                          │                                   │
│  │  socket.io (WebSocket)   │                                   │
│  └──────────────────────────┘                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 2.4 Dashboard 数据流

```
┌──── Dashboard (React 19 + Vite) ────────────────────────────────┐
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ App.tsx                                                  │    │
│  │  ├── Layout/                                             │    │
│  │  │   ├── Sidebar (Tab 导航)                              │    │
│  │  │   └── Main Content Area                               │    │
│  │  │                                                       │    │
│  │  ├── Pages                                               │    │
│  │  │   ├── DashboardPage.tsx (主仪表盘)                    │    │
│  │  │   ├── RecipesPage.tsx                                 │    │
│  │  │   └── XcodeSimulator.tsx                              │    │
│  │  │                                                       │    │
│  │  └── Views (9 个 Tab)                                    │    │
│  │      ├── Snippets    ──→ GET /api/snippets               │    │
│  │      ├── Recipes     ──→ GET /api/recipes                │    │
│  │      ├── AI          ──→ GET /api/ai/*                   │    │
│  │      ├── SPM         ──→ GET /api/spm/*                  │    │
│  │      ├── Candidates  ──→ GET/POST /api/candidates/*      │    │
│  │      ├── DepGraph    ──→ GET /api/search/graph/*         │    │
│  │      ├── Guard       ──→ GET /api/guard-rules/*          │    │
│  │      ├── Editor      ──→ POST /api/extract/*             │    │
│  │      └── Help        ──→ (静态)                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  api.ts ──HTTP──▶ localhost:3000/api/*                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. Gateway 控制平面详解

### 3.1 执行流水线

```
                         Gateway.execute(request)
                                │
                    ┌───────────┴───────────┐
                    │   validateRequest()    │  格式校验
                    │   actor + action 必填  │  (actor/action/resource/payload)
                    └───────────┬───────────┘
                                │
                    ┌───────────┴───────────┐
                    │  checkPermission()     │  PermissionManager.check()
                    │  3-tuple 权限检查     │  (actor, action, resource)
                    └───────────┬───────────┘
                                │
                    ┌───────────┴───────────┐
                    │ validateConstitution() │  ConstitutionValidator.validate()
                    │  P1-P4 优先级检查     │  (检查破坏性操作、AI 权限等)
                    └───────────┬───────────┘
                                │
                    ┌───────────┴───────────┐
                    │  runPlugins('pre')     │  前置插件 hook
                    └───────────┬───────────┘
                                │
                    ┌───────────┴───────────┐
                    │  routeToHandler()      │  分发到注册的 Action Handler
                    │  (GatewayActionRegistry│   27 个 Action)
                    └───────────┬───────────┘
                                │
                    ┌───────────┴───────────┐
                    │  runPlugins('post')    │  后置插件 hook
                    └───────────┬───────────┘
                                │
                    ┌───────────┴───────────┐
                    │  auditSuccess()        │  AuditLogger.log()
                    │  记录审计日志          │  (actor, action, result, duration)
                    └───────────┬───────────┘
                                │
                           return result
```

### 3.2 27 个 Gateway Action

```
candidate:                          recipe:
  ├── create                          ├── create
  ├── approve                         ├── publish
  ├── reject                          ├── deprecate
  ├── apply_to_recipe                 ├── update_quality
  ├── list                            ├── adopt
  ├── search                          ├── apply
  ├── get_stats                       ├── list
  ├── get                             ├── search
  └── delete                          ├── get_stats
                                      ├── get
guard_rule:                           ├── get_recommendations
  ├── create                          └── delete
  ├── enable
  ├── disable                       search:
  ├── check_code                      └── query
  ├── import_from_recipe
  ├── list
  ├── search
  ├── get_stats
  └── get
```

---

## 4. 宪法权限模型

### 4.1 三层权限架构

```
┌──────────────────────────────────────────────────────────┐
│  治理层 (Priorities)                                      │
│  P1 Data Integrity → P2 Human Oversight                  │
│  → P3 AI Transparency → P4 Helpfulness                   │
│  ConstitutionValidator 逐级验证                           │
├──────────────────────────────────────────────────────────┤
│  角色层 (Roles)                                           │
│  cursor_agent │ asd_ais │ guard_engine                   │
│  developer_admin │ developer_contributor │ visitor        │
│  PermissionManager 3-tuple check                         │
├──────────────────────────────────────────────────────────┤
│  能力层 (Capabilities)                                    │
│  git push --dry-run 探测                                  │
│  → admin / contributor / visitor                          │
│  CapabilityProbe 24h TTL Cache                           │
└──────────────────────────────────────────────────────────┘
```

### 4.2 角色权限矩阵

| 操作 \ 角色 | cursor_agent | asd_ais | guard_engine | dev_admin | dev_contributor | visitor |
|-------------|:---:|:---:|:---:|:---:|:---:|:---:|
| read:recipes | ✅ | ✅ | — | ✅ | ✅ | ✅ |
| read:guard_rules | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| read:candidates | — | ✅ | ✅ | ✅ | ✅ | ✅ |
| create:candidates | ✅ | ✅ | — | ✅ | — | — |
| submit:candidates | ✅ | — | — | ✅ | — | — |
| approve:candidates | — | — | — | ✅ | ✅ | — |
| create:recipes | — | — | — | ✅ | ✅ | — |
| write:audit_logs | — | — | ✅ | ✅ | — | — |
| search:query | — | — | — | ✅ | — | ✅ |
| * (全权限) | — | — | — | ✅ | — | — |

---

## 5. Recipe 数据流（Source of Truth）

```
┌─── 写入流 ──────────────────────────────────────────────────────┐
│                                                                  │
│  RecipeService.createRecipe(data)                                │
│       │                                                          │
│       ├──→ RecipeRepository.create(data) ──→ SQLite DB          │
│       │                                                          │
│       └──→ RecipeFileWriter._persistToFile(recipe)              │
│                   │                                              │
│                   └──→ AutoSnippet/recipes/{category}/{slug}.md │
│                         (YAML frontmatter + Markdown body)       │
│                         (含 _contentHash 完整性校验)             │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

┌─── 同步流 ──────────────────────────────────────────────────────┐
│                                                                  │
│  $ asd sync                                                      │
│       │                                                          │
│       ▼                                                          │
│  SyncService.sync()                                              │
│       │                                                          │
│       ├── 扫描 AutoSnippet/recipes/**/*.md                       │
│       │                                                          │
│       ├── 解析 YAML frontmatter                                  │
│       │                                                          │
│       ├── 校验 _contentHash                                      │
│       │     ├── hash 匹配 → 无变化，跳过                        │
│       │     ├── hash 不匹配 → 检测手动编辑，更新 DB             │
│       │     └── 无 hash → 首次同步，计算并写入                   │
│       │                                                          │
│       └── upsert 到 SQLite DB                                    │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 6. 依赖关系总图

### 6.1 npm 依赖（24 个）

| 类别 | 包 |
|------|---|
| **AI** | `@google/generative-ai`, undici (OpenAI) |
| **MCP** | `@modelcontextprotocol/sdk` |
| **数据库** | `better-sqlite3` |
| **向量** | `@zilliz/milvus2-sdk-node` |
| **HTTP** | `express`, `cors`, `helmet`, `socket.io` |
| **CLI** | `commander`, `inquirer`, `chalk`, `ora` |
| **工具** | `js-yaml`, `xml2js`, `uuid`, `dotenv`, `minimist`, `zod` |
| **文件** | `chokidar` (文件监控) |
| **网络** | `axios`, `redis` |
| **日志** | `winston` |

### 6.2 开发依赖（7 个）

`jest`, `supertest`, `eslint`, `prettier`, `mocha`, `nodemon`, `@types/node`
