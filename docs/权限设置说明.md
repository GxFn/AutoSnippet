# 权限设置说明

说明写权限探针、Recipe 保存频率控制、完整性校验三项可选能力的配置与行为。

---

## 项目结构约定

AutoSnippet 采用固定的项目结构，确保所有项目的一致性：

```
ProjectRoot/                        ← 项目根目录（如 BiliDemo）
├── AutoSnippet/                   ← AutoSnippet 目录（固定名称）
│   ├── AutoSnippet.boxspec.json  ← 配置文件
│   ├── recipes/                   ← Recipes 目录（固定路径）
│   └── .autosnippet/              ← 缓存和索引
└── [项目文件]
```

**路径查找规则**：
- 从任意目录执行 `asd` 命令时，会向上查找包含 `AutoSnippet/AutoSnippet.boxspec.json` 的目录
- 该目录即为项目根目录（ProjectRoot）
- 所有路径基于项目根目录计算

---

## 概述

| 能力 | 作用 | 启用条件 |
|------|------|----------|
| **写权限探针** | 保存/删除 Recipe 前在 `ProjectRoot/AutoSnippet/recipes` 执行 `git push --dry-run`，无 push 权限则 403 | 自动启用（路径通过 ProjectStructure 统一管理） |
| **Recipe 保存频率** | 对 POST /api/recipes/save 按「项目根 + IP」限流，超阈值 429 | 默认启用；`ASD_RECIPE_SAVE_RATE_LIMIT=0` 关闭 |
| **完整性校验** | `asd` 启动时对关键 JS 做 SHA-256 校验，不通过则退出 | 存在 `checksums.json` 且已构建 `bin/asd-verify`（仅 macOS） |

**适用场景**：信任部署环境；Recipe 上传（git push）由 Git 服务端权限拦截，满足「只有有权限者能推送」即可。

---

## 写权限探针

**目的**：保证管理员（有子仓库 push 权限者）能够正确提交 Recipe——通过在 `ProjectRoot/AutoSnippet/recipes` 目录执行 `git push --dry-run` 校验权限，无 push 权限者在 Dashboard 保存会 403。

### 路径管理

所有路径通过 `ProjectStructure` 模块统一管理：
- 项目根目录：通过向上查找 `AutoSnippet/AutoSnippet.boxspec.json` 确定
- Recipes 目录：`ProjectRoot/AutoSnippet/recipes`（固定路径）
- 缓存目录：`ProjectRoot/AutoSnippet/.autosnippet`

缓存时间可通过 `ASD_PROBE_TTL_SECONDS` 环境变量调整（默认 24 小时）。

### 把 AutoSnippet/recipes 做成子仓库（推荐）

只让有子仓库 push 权限的人能保存并上传 Recipe：

1. **建远程空仓库**（如 `BiliDemo-recipes`），不初始化 README。
2. **主项目里加 submodule**：
   ```bash
   cd ProjectRoot
   git submodule add <仓库 URL> AutoSnippet/recipes
   ```
3. **他人克隆后初始化 submodule**：
   ```bash
   git clone <主项目 URL>
   cd ProjectRoot
   git submodule update --init AutoSnippet/recipes
   ```

验证：在项目根目录运行 `asd status`，显示「写权限探针: 已配置」；无 push 权限时在 Dashboard 保存 Recipe 会 403。

---

## Recipe 保存频率控制

对 `/api/recipes/save` 按「项目根 + IP」固定窗口限流。

| 变量 | 含义 | 默认 |
|------|------|------|
| **ASD_RECIPE_SAVE_RATE_LIMIT** | 窗口内最多保存次数 | 20 |
| **ASD_RECIPE_SAVE_RATE_WINDOW_SECONDS** | 窗口长度（秒） | 60 |

设为 `0` 表示不限制。超限返回 429，前端提示「保存过于频繁，请稍后再试」。

---

## 完整性校验

- **入口**：`asd` 由 `bin/asd` 调用；若存在 `bin/asd-verify`（macOS 下 Swift 构建），先执行校验再 spawn Node；否则直接 `node bin/asd-cli.js`。
- **校验**：asd-verify 读 `checksums.json`，对关键 JS 做 SHA-256，不通过则 exit(1)。
- **无 checksums** 或未构建 asd-verify：不校验，直接跑 Node。
- **防直接运行**：asnip 启动时若存在 `checksums.json` 且未设置 `ASD_VERIFIED`（即未经过 asd-verify），默认仅警告；设 `ASD_STRICT_ENTRY=1` 则拒跑。开发可设 `ASD_SKIP_ENTRY_CHECK=1` 关警告。

**构建**：`npm run generate-checksums` 生成 `checksums.json`；`npm install` 会尝试构建 `bin/asd-verify`（需 macOS + Swift）。新增需校验文件时在 `scripts/generate-checksums.js` 的 `KEY_FILES` 中维护。

---

## 常见问题

- **为什么必须用 `AutoSnippet/recipes` 路径？** 该路径已固定，不支持自定义配置。所有项目均采用统一的 recipes 存储路径，简化部署和维护。
- **子模块已 clone 仍提示没权限？** 确认子模块正确初始化在 `AutoSnippet/recipes` 目录；运行 `git submodule update --init AutoSnippet/recipes` 确保子模块已拉取。
- **不想用完整性校验？** 不生成或删除 `checksums.json`；或设 `ASD_SKIP_ENTRY_CHECK=1` 关入口警告。写权限探针仍按配置生效。
- **无 Swift 如何验证校验？** 运行 `npm run verify-checksums` 或对应单元测试。
