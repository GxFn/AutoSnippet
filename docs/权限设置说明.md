# 权限设置说明

本文档说明 AutoSnippet 的**写权限探针**与**完整性校验**两项可选权限能力：配置方式、行为与常见问题。

---

## 一、概述

| 能力 | 作用 | 可选 |
|------|------|------|
| **写权限探针** | 保存/删除 Recipe、Snippet 前在指定子仓库目录执行 `git push --dry-run`；无 push 权限则返回 403，前端提示「没权限」。 | 是，未配置则不启用 |
| **Recipe 保存频率控制** | 对 POST /api/recipes/save 按「项目根 + IP」限流，超过阈值返回 429，防止短时间内多次创建/保存。 | 是，设为 0 则不启用 |
| **完整性校验** | `asd` 启动时（若存在原生入口与 `checksums.json`）对关键 JS 文件做 SHA-256 校验，不通过则退出。 | 是，无 checksums 或未构建则跳过 |

二者适用于「信任部署环境、防普通无权限用户」；不防本机/安装包篡改或直接运行 `node bin/asnip.js` 绕过。详见项目内或 BiliDemo 侧安全等级说明文档。

**默认行为**：未设置探针目录（未配置子仓库）时，不启用写权限探针，保存/删除 Recipe、Snippet 不受限制，相当于默认按管理员权限处理；只有配置了探针目录后才会按子仓库 push 权限做门控。

**不使用测试数据**：权限探针仅根据真实子仓库内 `git push --dry-run` 的结果判断，无测试开关或模拟数据；未配置探针目录时直接放行。

---

## 二、Recipe 保存频率控制

为防止短时间内多次创建/保存 Recipe，对 **POST /api/recipes/save**（新建 Recipe、编辑保存、候选审核保存为 Recipe）做进程内限流：按「项目根 + 客户端 IP」固定窗口计数，超过阈值则返回 429（`RECIPE_SAVE_RATE_LIMIT`），前端提示「保存过于频繁，请稍后再试」。

### 2.1 环境变量说明

| 变量 | 含义 | 默认 | 说明 |
|------|------|------|------|
| **ASD_RECIPE_SAVE_RATE_LIMIT** | 时间窗口内允许的**最多保存次数** | 20 | 在同一个窗口内，同一「项目根 + 同一 IP」最多允许保存这么多次；超过则 429。设为 **0** 表示不限制。 |
| **ASD_RECIPE_SAVE_RATE_WINDOW_SECONDS** | **时间窗口长度**（秒） | 60 | 与上配合：即「在 WINDOW_SECONDS 秒内，最多保存 RATE_LIMIT 次」。窗口是固定的：从第一次保存开始计时，满 WINDOW_SECONDS 秒后该 key 的计数清零，下一个保存重新开一个窗口。设为 **0** 表示不限制。 |

- **限流维度**：按「项目根路径 + 请求方 IP」区分；不同项目或不同 IP 各自计数，互不影响。
- **固定窗口**：例如 20 + 60 表示「任意连续 60 秒内最多 20 次」；若第 61 秒再保存，会重新开一个 60 秒窗口，又可保存 20 次。
- **示例**：`RATE_LIMIT=10`、`WINDOW_SECONDS=300` → 每 5 分钟内最多 10 次；`RATE_LIMIT=0` 或 `WINDOW_SECONDS=0` → 关闭限流。

### 2.2 涉及入口

Dashboard 新建 Recipe、编辑 Recipe 保存、Candidates 审核并保存为 Recipe（SPM 页保存）均走 `/api/recipes/save`，统一受上述频率控制；删除 Recipe、保存 Snippet 当前仅受写权限探针约束，未单独做频率限制。

---

## 三、写权限探针

### 3.1 配置方式

**方式一：环境变量（推荐）**

在项目根 `.env` 中设置：

```bash
# 探针目录：相对项目根的路径，即子仓库（submodule）在项目内的目录名
ASD_RECIPES_WRITE_DIR=auth-data

# 探针通过后的缓存时间（秒），此时间内不重复执行 git push --dry-run；默认 86400（24 小时）
# ASD_PROBE_TTL_SECONDS=86400
```

**方式二：rootSpec**

在 `AutoSnippetRoot.boxspec.json` 中设置：

```json
{
  "recipes": {
    "dir": "Knowledge/recipes",
    "writeDir": "auth-data"
  }
}
```

- `writeDir` 为探针目录（相对项目根）。环境变量 `ASD_RECIPES_WRITE_DIR` 优先于 rootSpec。
- **探针目录**应填子仓库在项目内的**目录名**（如 `auth-data`），勿填 GitHub 仓库名（如 `BiliDemo-auth-data`）。

### 3.2 行为说明

- **未配置**：不启用探针，保存/删除 Recipe、Snippet 行为与原有一致。
- **已配置**：在 `projectRoot + writeDir` 目录内执行 `git push --dry-run`；非零退出则视为无权限，返回 403，body 含 `{ error: '没权限', code: 'RECIPE_WRITE_FORBIDDEN' }`，前端展示固定友好提示（含「请勿擅自修改核心代码或安装包」）。
- **门控接口**：Recipe 保存、Recipe 删除、Snippet 保存、Snippet 删除；探针通过后仍写入主项目原路径（写老地方），不写子仓库。
- **缓存**：探针通过后进程内缓存，TTL 内不重复执行；进程重启后缓存清空，再次请求时重新探针。失败不缓存。

### 3.3 前置条件

- 主项目中已添加对应子仓库（如 `git submodule add <url> auth-data`）。
- 首次使用需执行 `git submodule update --init auth-data`（或你的子模块名）；否则探针目录可能不存在，探针失败并视为无权限。

---

## 四、完整性校验

### 4.1 机制简述

- **入口**：`asd` 命令由 `bin/asd` 脚本接管；若存在 `bin/asd-verify`（Swift 编译产物），则优先执行它，否则回退到 `node bin/asnip.js`。
- **校验**：`asd-verify` 在包根读取 `checksums.json`；若存在则对清单内关键文件（如 `bin/asnip.js`、`bin/ui.js`、`lib/writeGuard.js`）做 SHA-256 比对，不通过则 exit(1)，通过则 spawn `node bin/asnip.js [args]`。
- **无 checksums**：视为开发模式，不校验，直接 spawn Node。

### 4.2 配置与构建

- **生成清单**：`npm run generate-checksums` 在项目根生成 `checksums.json`。发布时 `prepublishOnly` 会自动执行，随包发布。
- **构建原生入口**：仅 macOS，`npm install` 时会尝试执行 `scripts/build-asd-entry.js` 构建 `bin/asd-verify`（需本机 Swift）；失败则静默跳过，`bin/asd` 回退到 Node。
- **校验脚本（无 Swift 可用）**：`npm run verify-checksums` 用 Node 复现校验逻辑，可用于 CI 或本地验证清单是否正确。

### 4.3 关键文件列表

新增或修改需参与校验的文件时，需在 `scripts/generate-checksums.js` 的 `KEY_FILES` 数组中维护路径（相对项目根）。

---

## 五、安全等级与适用场景

- **等级**：环境信任 + 防普通无权限用户（非高安全、非防篡改）。
- **适用**：团队内信任部署环境；限制无子仓库 push 权限的用户保存 Recipe/Snippet；提高随意篡改核心 JS 后直接使用的成本。
- **不适用**：需按用户身份细粒度授权、需抵御本机/安装包篡改或高安全认证的场景。

---

## 六、常见问题

**Q：探针目录填什么？**  
A：填子仓库在主项目内的目录名（如 `auth-data`），不要填 GitHub 仓库名（如 `BiliDemo-auth-data`）。探针会在 `项目根/auth-data` 下执行 `git push --dry-run`。

**Q：子仓库已 clone，但提示没权限？**  
A：确认运行 `asd ui` 时的项目根与 `ASD_RECIPES_WRITE_DIR` 指向的是同一份子仓库。若主项目内是 submodule（如 `BiliDemo/auth-data`），探针用的是这一份；单独克隆在外面的另一份仓库的 remote/权限与探针无关。

**Q：首次使用子模块需要做什么？**  
A：主项目 clone 后执行 `git submodule update --init auth-data`（或你的子模块名），否则探针目录可能不存在，会被视为无权限。

**Q：如何验证校验逻辑（无 Swift 环境）？**  
A：运行 `npm run generate-checksums` 生成 `checksums.json`，再运行 `npm run verify-checksums`；或运行单元测试 `node test/unit/checksums-verify.test.js`。

**Q：不想用完整性校验，只想要写权限探针？**  
A：不生成或删除 `checksums.json` 即可；或直接使用 `node bin/asnip.js` 启动（绕过 `asd`/`asd-verify`），写权限探针仍会在保存时执行（若已配置探针目录）。

---

## 七、相关文档

- `.env.example`：写权限探针相关环境变量说明。
- **BiliDemo** 项目 `docs` 下「AutoSnippet-原生入口与完整性校验」：完整性校验详细说明（构建、发布、单元测试）。AutoSnippet 内 `resources/asd-entry/README.md` 仅保留简述与指向。
- 使用文档、context/MCP/Guard 等见 [文档索引](./README.md)。
