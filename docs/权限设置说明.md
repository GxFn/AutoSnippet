# 权限设置说明

说明写权限探针、Recipe 保存频率控制、完整性校验三项可选能力的配置与行为。

---

## 概述

| 能力 | 作用 | 启用条件 |
|------|------|----------|
| **写权限探针** | 保存/删除 Recipe、Snippet 前在指定目录执行 `git push --dry-run`，无 push 权限则 403 | 配置 `ASD_RECIPES_WRITE_DIR` 或 rootSpec `recipes.writeDir` |
| **Recipe 保存频率** | 对 POST /api/recipes/save 按「项目根 + IP」限流，超阈值 429 | 默认启用；`ASD_RECIPE_SAVE_RATE_LIMIT=0` 关闭 |
| **完整性校验** | `asd` 启动时对关键 JS 做 SHA-256 校验，不通过则退出 | 存在 `checksums.json` 且已构建 `bin/asd-verify`（仅 macOS） |

**适用场景**：信任部署环境；Recipe 上传（git push）由 Git 服务端权限拦截，满足「只有有权限者能推送」即可。

---

## 写权限探针

**目的**：保证管理员（有子仓库 push 权限者）能够正确提交 Recipe——探针目录与 Recipe 写入目录一致，保存后可正常推送；无 push 权限者在 Dashboard 保存会 403。

### 配置

在项目根 `.env` 中设置（推荐）：

```bash
# 探针目录：子仓库在主项目内的路径，与 Recipe 写入目录一致，如 Knowledge/recipes
ASD_RECIPES_WRITE_DIR=Knowledge/recipes
```

或在 `AutoSnippetRoot.boxspec.json` 中设置 `recipes.writeDir`，环境变量优先。

探针在 `项目根 + writeDir` 下执行 `git push --dry-run`；非零则返回 403。通过后进程内缓存（默认 24 小时，`ASD_PROBE_TTL_SECONDS` 可改），门控 Recipe/Snippet 的保存与删除。

### 把 Knowledge/recipes 做成子仓库（推荐）

只让有子仓库 push 权限的人能保存并上传 Recipe：

1. **建远程空仓库**（如 `BiliDemo-recipes`），不初始化 README。
2. **主项目里加 submodule**：
   - 若尚无 `Knowledge/recipes` 或为空：  
     `git submodule add <仓库 URL> Knowledge/recipes`
   - 若已有内容：先在 `Knowledge/recipes` 内 `git init`、`remote add`、`add`、`commit`、`push`，再回项目根 `git rm -r Knowledge/recipes` 并提交，再执行 `git submodule add <仓库 URL> Knowledge/recipes`
3. **配置探针**：在 `.env` 中设 `ASD_RECIPES_WRITE_DIR=Knowledge/recipes`
4. **他人克隆后**：执行 `git submodule update --init Knowledge/recipes`

验证：`asd status` 显示「写权限探针: 已配置」；无 push 权限时在 Dashboard 保存 Recipe 会 403。

---

## Recipe 保存频率控制

对 `/api/recipes/save` 按「项目根 + IP」固定窗口限流。

| 变量 | 含义 | 默认 |
|------|------|------|
| **ASD_RECIPE_SAVE_RATE_LIMIT** | 窗口内最多保存次数 | 20 |
| **ASD_RECIPE_SAVE_RATE_WINDOW_SECONDS** | 窗口长度（秒） | 60 |

设为 `0` 表示不限制。超限返回 429，前端提示「保存过于频繁，请稍后再试」。

---

## 完整性校验

- **入口**：`asd` 由 `bin/asd` 调用；若存在 `bin/asd-verify`（macOS 下 Swift 构建），先执行校验再 spawn Node；否则直接 `node bin/asd-cli.js`。
- **校验**：asd-verify 读 `checksums.json`，对关键 JS 做 SHA-256，不通过则 exit(1)。
- **无 checksums** 或未构建 asd-verify：不校验，直接跑 Node。
- **防直接运行**：asnip 启动时若存在 `checksums.json` 且未设置 `ASD_VERIFIED`（即未经过 asd-verify），默认仅警告；设 `ASD_STRICT_ENTRY=1` 则拒跑。开发可设 `ASD_SKIP_ENTRY_CHECK=1` 关警告。

**构建**：`npm run generate-checksums` 生成 `checksums.json`；`npm install` 会尝试构建 `bin/asd-verify`（需 macOS + Swift）。新增需校验文件时在 `scripts/generate-checksums.js` 的 `KEY_FILES` 中维护。

---

## 常见问题

- **探针目录填什么？** 填子仓库在主项目内的路径（如 `Knowledge/recipes`），不要填远程仓库名。
- **子模块已 clone 仍提示没权限？** 确认 `ASD_RECIPES_WRITE_DIR` 与主项目内 submodule 路径一致；单独 clone 在外的那份仓库与探针无关。
- **不想用完整性校验？** 不生成或删除 `checksums.json`；或设 `ASD_SKIP_ENTRY_CHECK=1` 关入口警告。写权限探针仍按配置生效。
- **无 Swift 如何验证校验？** 运行 `npm run verify-checksums` 或对应单元测试。
