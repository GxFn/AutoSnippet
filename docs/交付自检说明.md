# AutoSnippet — 交付自检说明（MCP × Skills）

**日期**: 2026-02-05

本说明面向工程交付前的自检步骤，确保 Skills 与 MCP 能力闭环、可观测、安全约束已正确落地。

---

## 自检清单（必做）

- 诊断脚本：`npm run diagnose:mcp` 输出 UI 健康状态、环境配置、鉴权设置
- UI 健康：Dashboard `/api/health` 返回 `healthy`
- MCP 能力：`autosnippet_health` 与 `autosnippet_capabilities` 可调用
- 搜索与分析：`autosnippet_context_search` 与 `autosnippet_context_analyze` 工作正常
- 候选提交流程：`autosnippet_validate_candidate` / `autosnippet_check_duplicate` / `autosnippet_submit_candidates` 正常
- 草稿提交流程：`autosnippet_submit_draft_recipes` 可用，禁止操作知识库目录
- 结构元数据：`autosnippet_get_targets` / `autosnippet_get_target_files` / `autosnippet_get_target_metadata` 正常
- 反馈闭环：`autosnippet_confirm_recipe_usage` / `autosnippet_request_recipe_rating` 可用
- 安全约束：鉴权（可选 Token）与限流（提交）生效
- CI 工作流：GitHub Actions 自检（诊断报告、错误码检查、演示提交）通过
- JSON Envelope：所有工具返回 `{ success, errorCode?, message?, data?, meta }` 结构
- 错误码一致：20+ 错误码（如 `SEARCH_FAILED`, `RATE_LIMIT`, `ELICIT_FAILED`）在服务器中存在

---

## 快速运行

1) 启动 Dashboard（提供 `/api/health`）

```bash
npm run dashboard
```

2) 诊断 UI 与环境配置

```bash
npm run diagnose:mcp
```

输出包含：健康状态、`ASD_UI_URL`、`ASD_MCP_TOKEN` 配置与下一步建议。

3) MCP 客户端侧（Cursor/Claude Desktop）能力自检

- 调用 `autosnippet_health` / `autosnippet_capabilities`
- 测试搜索：`autosnippet_context_search` 输入示例："网络请求 重试"
- 测试分析：`autosnippet_context_analyze` 输入示例：`sourceRecipeIds: ["network/HTTP-Request-Retry.md"]`

---

## 鉴权与限流（安全）

- 鉴权：在 MCP 服务器环境设置 `ASD_MCP_TOKEN`，UI 请求将携带 `Authorization: Bearer <token>` 头。

```bash
export ASD_MCP_TOKEN=your_token
```

- 限流：在 `autosnippet_submit_candidates` 与 `autosnippet_submit_draft_recipes` 传入 `clientId`，启用提交频率保护。

示例：

```json
{
  "targetName": "_cursor",
  "items": [
    {
      "title": "Request with Retry",
      "trigger": "@request_retry",
      "language": "swift",
      "summary": "带重试的网络请求",
      "code": "...",
      "usageGuide": "..."
    }
  ],
  "clientId": "cursor-local"
}
```

---

## 统一输出 Envelope（建议）

为提升可观测性与调试体验，建议所有 MCP 工具统一采用 JSON Envelope：

```json
{
  "success": true,
  "errorCode": null,
  "message": "optional",
  "data": {},
  "meta": {
    "tool": "autosnippet_context_search",
    "version": "1.0.0",
    "responseTimeMs": 42,
    "source": "ui|intelligent|cache"
  }
}
```

---

## 验收项（交付前确认）

- MCP 工具 12 项齐备且调用成功
- 诊断脚本通过且输出建议合理
- 文档与代码一致（有鉴权、限流、健康、能力声明）
- 禁止直接修改知识库目录（遵守 Dashboard/Candidates 流程）

---

## Recipe 标准审核清单（提交/审核必看）

### A. Frontmatter 必填字段
- [ ] title：简洁明确（≤50 字）
- [ ] trigger：以 @ 开头、小写、无空格
- [ ] category：仅限 View / Service / Tool / Model / Network / Storage / UI / Utility
- [ ] language：swift 或 objectivec（intro-only 可用 markdown）
- [ ] summary / summary_cn：中文摘要必填
- [ ] summary_en：英文摘要（强烈建议）
- [ ] headers：完整 import 语句数组（Swift: `import X`；ObjC: `#import <X/Y.h>`）

### B. Body 内容规范
- [ ] Snippet / Code Reference：存在且为单一场景的可复用示例
- [ ] AI Context / Usage Guide：包含「何时使用 / 依赖与约束 / 扩展与变体」
- [ ] 代码块语言与 frontmatter `language` 一致

### C. 结构与一致性
- [ ] 一个 Recipe 仅覆盖一个使用场景
- [ ] 不包含多段不相关模式（需要拆分）
- [ ] 避免把模块名当 category
- [ ] headers 与 code 中的 import 保持一致

### D. 推荐项（提升搜索与 Guard）
- [ ] usageGuide_en（英文用法）
- [ ] keywords / tags（2-4 个语义标签）
- [ ] dependencies / compatibility / security（如适用）

### E. 安全与合规
- [ ] 不写入 AutoSnippet/recipes 目录（必须走 Dashboard 或 MCP）
- [ ] 候选提交使用 Candidates 流程，审核后再入库

---

## 常见问题

- **连接失败** → 确认 `npm run dashboard` 已启动；`ASD_UI_URL` 指向正确；无需在同一轮 MCP 调用中重复重试。
- **候选解析失败** → 检查草稿 Markdown 是否满足 Recipe Frontmatter 与结构；路径在知识库外；运行 `autosnippet_validate_candidate` 前校验。
- **提交受限** → 限流触发，请根据 `retryAfter` 等待后再尝试；或传入不同 `clientId` 以避免碰撞。
- **Envelope 读取失败** → 检查响应是否为有效 JSON；如不是，可能 UI 返回 HTML 错误页（确认健康检查通过）。

---

## 集成测试与 Envelope 断言

### 快速本地测试（使用 curl + node -e，避免 package.json 解析问题）

**成功路径**：
```bash
curl -sf -H "Content-Type: application/json" -d '{"targetName":"_test","items":[{"title":"Test","summary":"test","trigger":"@test","language":"swift","code":"//test","usageGuide":"test"}]}' http://localhost:3000/api/candidates/append | node -e "const d=require('fs').readFileSync(0,'utf8'); const j=JSON.parse(d); console.log(j.success ? '✓ SUCCESS' : '✗ FAIL'); process.exit(j.success ? 0 : 1);"
```

**错误码检查**：
```bash
node -e "const fs=require('fs');const s=fs.readFileSync('scripts/mcp-server.js','utf8');const codes=['HEALTH_CHECK_FAILED','SEARCH_FAILED','RATE_LIMIT','SUBMIT_FAILED','ELICIT_FAILED','OPEN_CREATE_FAILED','GET_TARGETS_FAILED'];const m=codes.filter(c=>!s.includes(\"errorCode: '\"+c+\"'\")); console.log(m.length?'Missing: '+m.join(', '):'✓ All codes present'); process.exit(m.length?1:0);"
```

**限流测试**：重复快速提交 5-10 次，同一 `clientId`；第 5+ 次预期收到 `{ success: false, errorCode: 'RATE_LIMIT' }`。

### CI 流程
- "Static Envelope Error Codes Check" 步骤验证所有错误码存在
- "Demo Candidates Submit" 步骤提交示例候选并验证 Envelope（成功/失败分支）
- 结果上传为 Artifacts（`mcp-report.json`, `demo-submit-result.json`）供审查

---

## 端到端演示流程（草稿 → 候选 → 审核）

### 本地手动演示

**步骤 1: 创建草稿**
```bash
mkdir -p .autosnippet-drafts
cat > .autosnippet-drafts/demo-request-pattern.md << 'EOF'
---
title: Demo Request Pattern
language: swift
trigger: @demo_request
category: Network
summary: Example network request
summary_en: Example network request
headers:
  - "import Foundation"
---

## Snippet / Code Reference

\`\`\`swift
let request = URLRequest(url: URL(string: "https://api.example.com")!)
let task = URLSession.shared.dataTask(with: request) { data, response, error in
  // Handle response
}
task.resume()
\`\`\`

## AI Context / Usage Guide

### When to Use
For basic HTTP GET requests with standard response handling.

### Implementation
Copy-paste the code and customize URL/headers.
EOF
```

**步骤 2: 提交草稿作为候选**
```bash
# 直接提交（如果 asd ui 运行在 localhost:3000）
curl -sf -H "Content-Type: application/json" -d '{"filePaths":[".autosnippet-drafts/demo-request-pattern.md"],"targetName":"_demo","source":"local-demo"}' http://localhost:3000/api/candidates/append

# 或使用 Node 脚本
node scripts/demo-candidates-submit.js
```

**步骤 3: Dashboard 审核**
- 打开 `http://localhost:3000` → Candidates 页面
- 看到提交的候选，质量评分、相似度提示、优先级
- 批准或拒绝各候选

**步骤 4: 采纳与评分（可选）**
```bash
# 如果支持 MCP Elicitation（Cursor）：
autosnippet_confirm_recipe_usage(recipeNames)
autosnippet_request_recipe_rating(recipeName, trigger)

# 或在 Dashboard Recipes 页手动设置权威分
```

### CI 演示
CI 工作流在 "Demo Candidates Submit" 步骤自动运行：
1. 内联候选 JSON（2 条示例：Request with Retry、WebView Load URL）
2. curl 提交到 `/api/candidates/append`
3. 捕获 Envelope 响应（成功、数量、目标名）
4. 上传 `demo-submit-result.json` 为 Artifact

---

## 安全性与限流详解

### 限流机制
- **关键字**：`projectRoot + clientId`（唯一标识客户端）
- **阈值**：每 30 秒最多 5 次提交
- **错误码**：`RATE_LIMIT`，附带 `retryAfter` 秒数建议
- **最佳实践**：
  - 单客户端操作：传入一致 `clientId`
  - 批量并发：为不同进程/用户传入不同 `clientId`，避免限流碰撞
  - 自动重试：读取 `retryAfter` 后等待再试（不在同一轮重试）

### 鉴权
- **Token**：设置环境变量 `ASD_MCP_TOKEN`
- **注入方式**：所有 HTTP 请求自动添加 `Authorization: Bearer <token>` 头
- **作用域**：保护提交端点；读操作可能为公开
- **未来**：支持角色与权限配置、参数化策略

---

## 完整交付清单

### 前置
- [ ] 代码合并到 main/master 分支
- [ ] 本地运行 `npm run dashboard` 与诊断无异常

### MCP 服务器
- [ ] `asd mcp` 启动成功，无错误日志
- [ ] `autosnippet_health` 返回 UI 健康状态
- [ ] `autosnippet_capabilities` 列出 14+ 工具
- [ ] Authorization 头在 `ASD_MCP_TOKEN` 设置时正确注入

### JSON Envelope
- [ ] 所有工具返回 `{ success, errorCode?, message?, data?, meta }` 结构
- [ ] 20+ 错误码（如 `SEARCH_FAILED`, `RATE_LIMIT`, `ELICIT_FAILED`）在代码中定义
- [ ] `meta.tool` 字段存在于所有响应中

### Skills 文档
- [ ] `autosnippet-concepts`: 自检与回退指导已加入
- [ ] `autosnippet-candidates`: Envelope 读取与错误码处理已文档化
- [ ] 其他 Skills：审查一致性

### CI & 工件
- [ ] "MCP Diagnosis Report (inline)" 步骤生成并上传诊断报告
- [ ] "Static Envelope Error Codes Check" 步骤通过
- [ ] "Demo Candidates Submit" 步骤成功并上传演示结果

### 测试
- [ ] 单元测试通过（如有）
- [ ] 集成测试通过（Dashboard 健康、Envelope 校验、演示流程）
- [ ] 本地演示流程（草稿 → 候选 → 审核）可复现

### 发布前确认
- [ ] 所有检查项通过
- [ ] 无遗留 TODO 或 FIXME 注释与已知问题
- [ ] 文档与代码版本一致
- [ ] 安全配置（Token、限流、知识库守卫）正确应用
