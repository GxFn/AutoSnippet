# AutoSnippet - 权威评分系统与数据格式

设计原则：**两个维度、一个对外数值、公式固定可审计**，便于团队与 AI 一致理解「谁更值得优先用」。

---

## 一、recipe-stats.json 数据格式

路径：`Knowledge/.autosnippet/recipe-stats.json`。

```json
{
  "schemaVersion": 1,
  "byTrigger": {
    "@BDRequest": {
      "guardUsageCount": 2,
      "humanUsageCount": 5,
      "aiUsageCount": 3,
      "lastUsedAt": "2026-02-01T10:00:00Z",
      "authority": 4
    }
  },
  "byFile": {
    "BDRequestDefine.md": {
      "guardUsageCount": 2,
      "humanUsageCount": 5,
      "aiUsageCount": 3,
      "lastUsedAt": "2026-02-01T10:00:00Z",
      "authority": 4
    }
  }
}
```

- **主键**：byTrigger（trigger 字符串）、byFile（Recipe 文件名）；插入/更新时**双写**。
- **三种使用**：**guardUsageCount**（审查时被用作上下文）、**humanUsageCount**（人工使用：as:search、CLI）、**aiUsageCount**（AI 查询与使用：MCP 采纳等）。
- **权威分 authority**：0～5，仅由项目/维护者在 Dashboard 或 CLI 设定，表示「官方推荐度」；未设定则为 0。

---

## 二、两个维度（仅存储与输入）

| 维度 | 含义 | 来源 |
|------|------|------|
| **使用热度 Usage Heat** | 该 Recipe 被参考、被使用的频次（行为数据） | 审查/人工/AI 使用，按 source 累加三档计数 |
| **权威分 Authority** | 项目/维护者对该 Recipe 的推荐度（人工认定） | Dashboard 或 CLI 设置，0～5；未设置=0 |

- **使用热度**：纯行为，不可人工改；**权威分**：纯人工，不可由行为自动改。二者分离。

---

## 三、使用热度公式（Usage Heat）

- **公式**：`usageHeat = w_guard × guardUsageCount + w_human × humanUsageCount + w_ai × aiUsageCount`
- **权重**：`w_guard`、`w_human`、`w_ai` 为可配置非负实数，建议默认 `1, 2, 1`（人工使用权重更高）。配置可放在 `Knowledge/.autosnippet/recipe-stats-weights.json` 或 boxspec 的 `recipes.statsWeights`。
- **语义**：数值越大表示被参考、被使用越多。

---

## 四、综合权威分（Authority Score）—— 唯一用于排序与推荐的数值

- **公式**：  
  `authorityScore = α × normalize(usageHeat) + (1 − α) × (authority / 5)`  
  - `normalize(usageHeat)`：在当前项目所有 Recipe 的 usageHeat 中做线性归一化到 0～1。  
  - `authority / 5`：将 0～5 映射到 0～1。  
  - `α`：使用热度占比，0～1；建议默认 **0.5**（热度与人工权威各占一半）。
- **语义**：**Authority Score 越高，越应优先推荐该 Recipe**。Search、Guard、Dashboard、AI 上下文统一用此数值排序。
- **可审计**：公式与权重写在文档与配置中，可复现。

---

## 五、权重配置示例

文件 `Knowledge/.autosnippet/recipe-stats-weights.json`（或 boxspec 内 `recipes.statsWeights`）：

```json
{
  "w_guard": 1,
  "w_human": 2,
  "w_ai": 1,
  "usageWeight": 0.5
}
```

- `usageWeight` 即上述 α；`(1 - usageWeight)` 为权威分占比。

---

## 六、如何对 Recipe 权威打分

权威分取值为 **0～5**，表示「官方推荐度」。可用以下方式设置：

### 1. Dashboard 页内打分（推荐）

启动 `asd ui`，打开 Dashboard → **Recipes** 页，在对应 Recipe 卡片上点击 **1～5 星**，即参与综合权威分计算。

### 2. Cursor 内 MCP 弹窗打分

当 Cursor Agent 采纳或推荐某条 Recipe 后，可调用 MCP 工具 **`autosnippet_request_recipe_rating`**，由 Cursor 弹出表单让用户打 0～5 星，结果会写入 `recipe-stats` 并影响综合权威分。需 Cursor 支持 MCP Elicitation 且 **`asd ui` 已运行**。

---

## 七、采纳表单（确认代码使用）

- **意义**：向用户弹出「是否采纳/使用」确认；用户点击确认后记为**人工使用一次**（humanUsageCount +1），影响 Recipe 使用统计与综合权威分排序。
- **何时出现**：可由 **Cursor 自行判断**是否给出（例如用户明确表示采纳时，或 Cursor 推断用户已采纳该 Recipe 时）；也可仅在用户明确表达采纳（如「可以采纳」「我采纳」「确认使用」）时调用。**不要在**仅展示 Recipe 或用户仅询问「是否要采纳」时主动弹出采纳表单。
- **search 保持静默**：`autosnippet_context_search` 仅做检索与返回 Recipe 内容，不触发表单。
