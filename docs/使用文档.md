# AutoSnippet 使用文档

安装、常用命令、编辑器内指令、配置与 Recipe 格式说明。更多概览见仓库根目录 [README](../README.md)。

---

## 安装与快速开始

```bash
npm install -g autosnippet
```

在**项目根目录**（含 `AutoSnippetRoot.boxspec.json`）执行：

```bash
asd setup      # 初始化
asd ui         # 启动 Dashboard（建议常驻）
```

`asd ui` 会启动 Web 管理后台并后台 watch；首次运行若前端不存在会自动构建。浏览器会自动打开 Dashboard。

---

## 核心流程

1. **组建知识库**：`asd ais <Target>` 或 `asd ais --all` → Dashboard Candidates 审核 → Recipe 入库
2. **依赖关系**：`asd spm-map` 或 Dashboard 刷新
3. **Cursor 集成**：`asd install:cursor-skill --mcp`（安装 Skills + Cursor 规则 + MCP，需 `asd ui` 运行）
4. **语义索引**：`asd ui` 启动时自动 embed；也可手动 `asd embed`

---

## 编辑器内指令

需先运行 `asd watch` 或 `asd ui`。在源码中写入并保存：

| 指令 | 作用 |
|------|------|
| `// as:create` / `// as:c` | 无选项时只打开 Dashboard（路径已填），由用户点 Scan File 或 Use Copied Code。`-c` 强制用剪切板（静默创建或打开）；`-f` 强制用路径（打开 Dashboard 并自动执行 Scan File） |
| `// as:guard` / `// as:g` [关键词或规模] | 按知识库 AI 审查，输出到终端。**无后缀**时仅检查**当前文件**；后缀 **file** / **target** / **project** 可扩大范围（target=当前 target 内所有源文件，project=项目内所有源文件）；其他为检索关键词 |
| `// as:search` / `// as:s` [关键词] | 从知识库检索并插入 Recipe/Snippet |
| `// as:include` / `// as:import` | Snippet 内头文件/模块标记，保存时自动注入 |

**静默候选**：在 Cursor 内用户提出保存案例，Cursor 生成草案；后台用草案静默创建候选，到 Dashboard **Candidates** 页审核即可。  
**搜索无跳转**：`// as:search` / `// as:s` 在编辑器内弹窗或终端选择，即选即插，无需跳转 Dashboard。

---

## 工作流

当前支持的几条主要工作流如下。

| 工作流 | 入口 | 结果 |
|--------|------|------|
| **创建 / 沉淀** | `// as:create`、`asd create --clipboard`、`asd candidate`、Dashboard 新建、MCP 批量提交 | 候选进 **Candidates** 页，审核后入库为 Recipe/Snippet；`as:create -c` 可静默从剪贴板创建候选 |
| **检索 / 插入** | `// as:search`、`asd search --copy` / `--pick`、MCP `autosnippet_context_search` | 选一条插入或复制；会记录一次使用（recipe-stats），影响综合权威分与排序 |
| **确认代码使用** | MCP `autosnippet_confirm_recipe_usage`（可由 Cursor 自行判断何时给出，或仅在用户明确说「可以采纳」「我采纳」「确认使用」时调用） | 弹出「确认使用」提示；用户确认后记为 human 使用（humanUsageCount +1）。检索仅静默返回，不主动触发表单。需 Cursor 支持 MCP Elicitation。 |
| **审查** | `// as:guard`、`// as:g file`、`// as:g target`、`// as:g project` | 无后缀时仅检查**当前文件**；**target**/**project** 可扩大范围。拉取 Recipe → 静态规则（可带 dimension）→ file/target/project 审计 → AI 审查；违反项可带 **filePath**（target/project 时），写入 **guard-violations.json** 并在 **Guard** 页展示 |
| **评分 / 权威分** | Dashboard **Recipes** 页卡片内 1～5 星、MCP `autosnippet_request_recipe_rating`（Cursor 1.5+ 弹窗打分） | 写入 recipe-stats 的 authority（0～5），与使用热度一起算综合权威分，用于排序与推荐 |
| **Guard 规则与违反** | iOS 版本规则：`Knowledge/.autosnippet/guard-rules.json`（JSON，可编辑）；违反记录：同目录 `guard-violations.json` | Dashboard **Guard** 页可查看 iOS 版本规则表与历次违反记录，支持清空历史 |

- **使用统计**：as:search 插入、asd search 选中、Guard 引用、MCP 检索/采纳等按来源（human/guard/ai）记入 recipe-stats；采纳表单可由 Cursor 自行判断是否给出，或仅在用户明确表示采纳时调用 `autosnippet_confirm_recipe_usage`，记为 human 使用。
- **综合权威分**：由使用热度与人工权威分加权计算，用于排序与推荐；详见 [权威评分系统与数据格式](./权威评分系统与数据格式.md)。

---

## Dashboard 使用说明

Dashboard（`asd ui` 启动后浏览器打开）主要页面与用法如下。

| 页面 | 说明 |
|------|------|
| **Recipes** | 查看、编辑 Recipe；卡片上显示**权威分**（0～5 星）与**使用统计**（g: 审查 / h: 人工 / a: AI）。点击卡片进入编辑，可在编辑窗口顶部设置权威分（1～5 星）。列表按**综合权威分**从高到低排序。 |
| **Candidates** | 审核待入库的候选（来自 as:create、MCP 批量提交、`asd ais` 等），通过后保存为 Recipe/Snippet。 |
| **Guard** | 查看 iOS 版本规则表与历次违反记录；支持清空历史、AI 写入规则。 |
| **Snippets** | 管理 Xcode 代码片段与 trigger。 |
| **Help** | 使用说明与 MCP 工具一览。 |

**权威分与使用统计**：权威分表示「官方推荐度」，由项目/维护者在 Recipes 页或 MCP 弹窗中设置；使用统计（guard/human/ai）为行为计数，不可手动改。二者共同参与综合权威分计算，数值越高越优先推荐。详见 [权威评分系统与数据格式](./权威评分系统与数据格式.md)。

---

### iOS 版本规则：如何增加

iOS 版本规则（静态规则）存放在项目根下 `Knowledge/.autosnippet/guard-rules.json`。**增加规则**：直接编辑该 JSON，在 `rules` 里新增一条，键为规则 ID（英文，如 `my-custom-rule`），值为：

| 字段 | 必填 | 说明 |
|------|------|------|
| `message` | 是 | 违反时提示的说明 |
| `severity` | 是 | `"error"` 或 `"warning"` |
| `pattern` | 是 | 正则表达式，对**每一行**代码匹配；JSON 中反斜杠需双写（如 `\\s`） |
| `languages` | 是 | 适用语言：`["objc"]`、`["swift"]` 或 `["objc", "swift"]` |
| `note` | 否 | 备注（如「仅作简单提示」） |
| `dimension` | 否 | 审查规模：`"file"` / `"target"` / `"project"`。有值时仅当用户写 `as:g file` / `as:g target` / `as:g project` 时运行该规则；不写则任意规模均运行 |

示例（在 `rules` 中追加一条）：

```json
"no-force-unwrap": {
  "message": "避免使用强制解包，建议 if let / guard let",
  "severity": "warning",
  "pattern": "!\\s*[)\\]}]",
  "languages": ["swift"]
}
```

保存后，下次执行 `// as:guard` 或 `// as:g [file|target|project]` 时会自动加载；Dashboard **Guard** 页规则表也会显示新增规则及「审查规模」列。若项目下尚未生成该文件，先跑一次 `// as:guard` 或启动 `asd ui` 后会在首次读取时自动创建并写入**内置规则**，包括：主线程 sync、UI 主线程、dealloc 内异步/通知、嵌套 dispatch_sync、@synchronized+dispatch_sync、init 内 return nil、主队列/回调中 dispatch_sync、锁内 wait/sleep、可变容器+多线程提示、主线程阻塞提示（sleep/usleep）、Block 循环引用启发式、**NSTimer target:self 循环引用**、**Swift as! / try!**、KVO/NSNotificationCenter 未 removeObserver 等，用户可编辑 guard-rules.json 增删。**对正则不可靠的项**（如 init 内 return nil、Block 内 self.）会先做**代码判断**（方法/块范围分析），再决定是否报违反；KVO/通知配对检查为代码内置，不写入 JSON。**静态难做全的经典错误**（如 delegate 强引用、KeyPath 拼写、枚举时修改容器、格式串与参数类型不匹配）需依赖人工或更复杂分析。**AI 写入规则**时，生成结果会包含 `dimension` 建议（同文件 / 同 target / 同项目），用户可修改后确认写入。

**OC 多维度审查（无需配置）**：除上述按行正则规则外，Guard 对 **Objective-C** 的 Category 重名按三个维度分别审查，违反项会带 `dimension` 便于区分：

| 维度 | 范围 | 检查内容 |
|------|------|----------|
| **同文件** | 当前文件 | 同一文件内 `@interface ClassName (CategoryName)` 出现多次 |
| **同 target** | 当前文件所属 SPM target 下所有 .m/.h | 同一 target 内多文件或同文件多处出现同名 Category（需项目含 Package.swift 且文件在某一 target 下） |
| **同项目** | 项目下所有 .m/.h（跳过 node_modules、Pods、build 等） | 整个项目内多文件或同文件多处出现同名 Category |

规则 ID 均为 `objc-duplicate-category`，违反说明中会列出「另见 某文件:行号」；Dashboard Guard 违反记录中会显示「同文件 / 同 target / 同项目」标签。该审查不写入 guard-rules.json，无法关闭或修改。**Guard 统一接入**：`lib/guard/guardRules.js` 按语言分发到各语言模块；**iOS（objc/swift）** 规则与审计在 `guardRules-iOS.js`，其他语言新增独立文件（如 `guardRules-Android.js`）并在 `guardRules.js` 中注册即可接入。

---

## 常用命令

| 命令 | 说明 |
|------|------|
| `asd ui` | 启动 Dashboard + watch |
| `asd status` | 环境自检（项目根、AI、索引、Native UI） |
| `asd create --clipboard` | 从剪贴板创建 Recipe/Snippet |
| `asd candidate` | 从剪贴板创建候选（Dashboard 审核） |
| `asd install` / `asd i` | 同步 Snippets 到 Xcode |
| `asd ais [Target]` | AI 扫描 Target → Candidates |
| `asd search [keyword] --copy` | 搜索并复制第一条到剪贴板 |
| `asd search [keyword] --pick` | 交互选择后复制/插入 |
| `asd install:cursor-skill --mcp` | 安装 Skills、Cursor 规则并配置 MCP（需 `asd ui` 运行） |
| `asd install:full` | 全量安装；`--parser` 含 Swift 解析器；`--lancedb` 仅 LanceDB |
| `asd embed` | 手动构建语义向量索引 |
| `asd spm-map` | 刷新 SPM 依赖映射 |

### 用 Cursor 做批量扫描

在 Cursor 里让 Agent 通过 MCP 工具（`autosnippet_get_targets` → `autosnippet_get_target_files` → 按文件提取 → `autosnippet_submit_candidates`）扫描指定 Target，用 Cursor 模型提取候选并提交到 Dashboard，再到 **Candidates** 页审核入库。

---

## 配置

- **AI**：项目根 `.env`，设置 `ASD_GOOGLE_API_KEY` 等（见 `.env.example`）。可选 `ASD_AI_PROVIDER`、代理等。
- **LanceDB**：`asd install:full --lancedb`，在 boxspec 的 `context.storage.adapter` 中配置 `"lance"`。
- **语义索引**：见 [context 配置说明](./context配置说明.md)。  
- **Cursor MCP**：见 [MCP 配置说明](./MCP配置说明.md)。

---

## Recipe 格式

完整 Recipe 为 Markdown 文件，需包含：

- **Frontmatter**（`---` 包裹的 YAML）：`title`、`trigger` 必填；可选 `category`、`language`、`headers` 等
- **Snippet / Code Reference**：下接代码块，供 Snippet 与检索使用
- **AI Context / Usage Guide**：使用说明，供 AI 与 Guard 检索

---

## 术语

- **Recipe**：`Knowledge/recipes/` 下的 Markdown 知识，供 AI 检索、Guard、搜索
- **Snippet**：Xcode 代码片段，通过 trigger（默认 `@`）补全
- **项目根**：含 `AutoSnippetRoot.boxspec.json` 的目录

详细概念见 [术语与 Skills](./术语与Skills.md)。
