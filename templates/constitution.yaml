# ═══════════════════════════════════════════════════════════
# AutoSnippet Constitution — 权限宪法
# ═══════════════════════════════════════════════════════════
#
# 三层权限架构:
#   ① 能力层 (capabilities) — git push --dry-run 探测物理写权限
#   ② 角色层 (roles)        — 角色权限矩阵 (action:resource)
#   ③ 治理层 (rules)        — 扁平规则引擎
#
# 双路径模式:
#   AUTH_ENABLED=false → 子仓库探针自动决定角色（能力层驱动）
#   AUTH_ENABLED=true  → 登录后根据用户配置角色（角色层驱动）
# ═══════════════════════════════════════════════════════════

version: "3.0"
effective_date: "2026-02-13"

# ─── 能力探测 ─────────────────────────────────────────────
capabilities:
  git_write:
    description: "子仓库 git push 权限"
    probe: "git push --dry-run"
    no_subrepo: "allow"
    no_remote: "allow"
    cache_ttl: 86400

# ─── 治理规则（扁平规则替代优先级层级） ─────────────────
rules:
  - id: "destructive_confirm"
    description: "删除操作需要确认"
    check: "destructive_needs_confirmation"
  - id: "content_required"
    description: "创建 candidate/recipe 需要内容"
    check: "creation_needs_content"
  - id: "ai_no_direct_recipe"
    description: "AI 不能直接创建/批准 recipe"
    check: "ai_cannot_approve_recipe"
  - id: "batch_authorized"
    description: "批量操作需要授权"
    check: "batch_needs_authorization"

# ─── 角色定义 ─────────────────────────────────────────────
roles:
  - id: "external_agent"
    name: "External Agent"
    description: "IDE 中的外部 AI Agent（Cursor / Copilot / Claude Code）"
    permissions:
      - "read:recipes"
      - "read:guard_rules"
      - "create:candidates"
      - "submit:candidates"
      - "read:audit_logs:self"
      - "knowledge:bootstrap"
      - "create:skills"
    constraints:
      - "不能直接修改 Recipe"
      - "不能修改 Guard 规则"
      - "不能删除任何数据"

  - id: "chat_agent"
    name: "ChatAgent"
    description: "AutoSnippet 内置 AI Agent（Dashboard 对话 / 程序化调用）"
    permissions:
      - "read:recipes"
      - "read:candidates"
      - "create:candidates"
      - "read:guard_rules"
    constraints:
      - "生成的 Candidate 必须包含完整 Reasoning"
      - "不能绕过 Guard 检查"

  - id: "developer"
    name: "开发者"
    description: "项目 Owner，完整权限"
    permissions:
      - "*"
    requires_capability:
      - "git_write"
