#!/usr/bin/env node
/**
 * å°† AutoSnippet è‡ªå¸¦çš„ Agent Skills å®‰è£…åˆ°ã€Œå½“å‰é¡¹ç›®æ ¹ã€çš„ Cursor ç¯å¢ƒï¼ˆé¡¹ç›®æ ¹/.cursor/skills/ï¼‰ã€‚
 * é¡¹ç›®æ ¹ï¼šä»å½“å‰å·¥ä½œç›®å½•å‘ä¸ŠæŸ¥æ‰¾å« AutoSnippetRoot.boxspec.json çš„ç›®å½•ï¼›æœªæ‰¾åˆ°åˆ™ç”¨å½“å‰ç›®å½•ã€‚
 * å¯¹ autosnippet-recipesï¼šä¼šä»é¡¹ç›® Knowledge/recipes/ï¼ˆæˆ– spec.recipes.dirï¼‰ç”Ÿæˆ references/project-recipes-context.mdï¼Œä¾› Cursor ä½œä¸ºé¡¹ç›®ä¸Šä¸‹æ–‡åŠ è½½ã€‚
 * è¿è¡Œæ–¹å¼ï¼šåœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ npm run install:cursor-skillï¼Œæˆ– asd install:cursor-skillï¼Œæˆ– node scripts/install-cursor-skill.js
 */

const fs = require('fs');
const path = require('path');

const autoSnippetRoot = path.join(__dirname, '..');
const skillsSource = path.join(autoSnippetRoot, 'skills');

let projectRoot = process.cwd();
try {
	const findPath = require(path.join(autoSnippetRoot, 'bin', 'findPath.js'));
	const found = findPath.findProjectRootSync(process.cwd());
	if (found) projectRoot = found;
} catch (err) {}

const skillsTarget = path.join(projectRoot, '.cursor', 'skills');

if (!fs.existsSync(skillsSource)) {
	console.error('âŒ æœªæ‰¾åˆ° skills ç›®å½•:', skillsSource);
	process.exit(1);
}

const skillDirs = fs.readdirSync(skillsSource, { withFileTypes: true })
	.filter(d => d.isDirectory())
	.map(d => d.name);

if (skillDirs.length === 0) {
	console.log('â„¹ï¸  skills ä¸‹æš‚æ—  skill ç›®å½•ï¼Œè·³è¿‡å®‰è£…ã€‚');
	process.exit(0);
}

if (!fs.existsSync(skillsTarget)) {
	fs.mkdirSync(skillsTarget, { recursive: true });
}

function getRecipesDir(root) {
	const specPath = path.join(root, 'AutoSnippetRoot.boxspec.json');
	if (!fs.existsSync(specPath)) return path.join(root, 'Knowledge', 'recipes');
	try {
		const spec = JSON.parse(fs.readFileSync(specPath, 'utf8'));
		const dir = spec && spec.recipes && spec.recipes.dir;
		return dir ? path.join(root, dir) : path.join(root, 'Knowledge', 'recipes');
	} catch (e) {
		return path.join(root, 'Knowledge', 'recipes');
	}
}

function collectMdFiles(dir, baseDir, list = []) {
	if (!fs.existsSync(dir)) return list;
	const entries = fs.readdirSync(dir, { withFileTypes: true });
	for (const e of entries) {
		const full = path.join(dir, e.name);
		if (e.isDirectory() && !e.name.startsWith('.')) {
			collectMdFiles(full, baseDir, list);
			continue;
		}
		if (e.isFile() && e.name.toLowerCase().endsWith('.md')) {
			list.push(path.relative(baseDir, full).replace(/\\/g, '/'));
		}
	}
	return list;
}

function buildProjectRecipesContext(projectRoot) {
	const recipesDir = getRecipesDir(projectRoot);
	if (!fs.existsSync(recipesDir)) return null;
	const mdFiles = collectMdFiles(recipesDir, recipesDir).sort();
	if (mdFiles.length === 0) return null;
	const parts = ['# Project Recipes Context\n', 'Generated by `asd install:cursor-skill`. Use this as the project standards and Guard context.\n'];
	for (const rel of mdFiles) {
		const full = path.join(recipesDir, rel);
		try {
			const content = fs.readFileSync(full, 'utf8');
			parts.push('\n---\n\n## Recipe: ' + rel + '\n\n');
			parts.push(content);
			parts.push('\n');
		} catch (err) {
			parts.push('\n---\n\n## Recipe: ' + rel + '\n\n*(read error)*\n');
		}
	}
	return parts.join('');
}

for (const name of skillDirs) {
	const src = path.join(skillsSource, name);
	const dest = path.join(skillsTarget, name);
	if (fs.existsSync(dest)) {
		fs.rmSync(dest, { recursive: true });
	}
	fs.cpSync(src, dest, { recursive: true });
	console.log('âœ… å·²å®‰è£… skill:', name, '->', dest);

	if (name === 'autosnippet-recipes') {
		const context = buildProjectRecipesContext(projectRoot);
		const refDir = path.join(dest, 'references');
		if (!fs.existsSync(refDir)) fs.mkdirSync(refDir, { recursive: true });
		const contextPath = path.join(refDir, 'project-recipes-context.md');
		if (context) {
			fs.writeFileSync(contextPath, context, 'utf8');
			console.log('âœ… å·²ç”Ÿæˆé¡¹ç›® Recipe ä¸Šä¸‹æ–‡:', contextPath);
		} else {
			if (fs.existsSync(contextPath)) fs.unlinkSync(contextPath);
			console.log('â„¹ï¸  é¡¹ç›®æš‚æ—  recipesï¼Œæœªç”Ÿæˆ project-recipes-context.md');
		}
	}
}

console.log('ğŸ¯ Cursor skills å·²å°±ç»ªï¼Œå®‰è£…åˆ°é¡¹ç›®:', projectRoot);
console.log('   é‡å¯ Cursor æˆ–æ–°å¼€ Agent å¯¹è¯åç”Ÿæ•ˆã€‚');
