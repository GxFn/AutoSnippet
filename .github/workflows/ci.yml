# AutoSnippet CI：推送/PR 时构建与单元测试
name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install dashboard dependencies
        run: cd dashboard && npm ci

      - name: Build Dashboard
        run: npm run build:dashboard

      - name: Start Dashboard (background)
        run: npm run dashboard -- --port 3100 --no-open &
        env:
          ASD_SKIP_ENTRY_CHECK: '1'
          ASD_DISABLE_WRITE_GUARD: '1'
          ASD_DISABLE_RATE_LIMIT: '1'

      - name: Wait for Dashboard
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:3100/api/health > /dev/null; then
              echo "Dashboard ready"
              exit 0
            fi
            sleep 2
          done
          echo "Dashboard not ready"
          exit 1

      - name: MCP Diagnosis Report (inline)
        run: |
          set -e
          HEALTH=$(curl -sf http://localhost:3100/api/health || echo "{}")
          echo "$HEALTH" > mcp-health.json
          node -e "const fs=require('fs'); const health=JSON.parse(fs.readFileSync('mcp-health.json','utf8')); const ok=Boolean(health && (health.status==='healthy'||health.healthy===true)); const report={success: ok, message: ok?'UI 健康检查通过':'UI 不健康', data:{health}, meta:{checker:'ci-inline', baseUrl:'http://localhost:3100'}}; fs.writeFileSync('mcp-report.json', JSON.stringify(report,null,2)); process.exit(ok?0:1);"

      - name: Upload Diagnosis Report
        uses: actions/upload-artifact@v4
        with:
          name: mcp-report
          path: mcp-report.json

      - name: Demo Candidates Submit
        run: |
          cat > sample-candidates.json << 'JSON'
          {
            "targetName": "_demo",
            "items": [
              {
                "title": "Request with Retry",
                "summary": "带重试的网络请求示例",
                "summary_en": "Network request example with retry logic",
                "trigger": "@network_retry",
                "language": "swift",
                "code": "func requestWithRetry() { /* ... */ }",
                "usageGuide": "在网络不稳定时采用指数退避进行重试；注意幂等性与超时设置。",
                "usageGuide_en": "Use exponential backoff on unstable networks; mind idempotency and timeouts."
              },
              {
                "title": "WebView Load URL",
                "summary": "使用 WebView 加载 URL 的标准方式",
                "summary_en": "Standard way to load a URL into WebView",
                "trigger": "@webview_load_url",
                "language": "objectivec",
                "code": "[webView loadRequest:[NSURLRequest requestWithURL:url]]; // ...",
                "usageGuide": "在主线程发起加载；校验 URL 格式与空值；必要时添加缓存策略。",
                "usageGuide_en": "Initiate on main thread; validate URL and nulls; optional cache policy."
              }
            ],
            "source": "ci-demo",
            "expiresInHours": 24
          }
          JSON
          curl -sf -H "Content-Type: application/json" -d @sample-candidates.json http://localhost:3100/api/candidates/append | tee demo-submit-result.json

      - name: Upload Demo Submission Result
        uses: actions/upload-artifact@v4
        with:
          name: demo-candidates-result
          path: demo-submit-result.json

      - name: Static Envelope Error Codes Check
        run: |
          node -e "const fs=require('fs');const s=fs.readFileSync('scripts/mcp-server.js','utf8');const exp=['HEALTH_CHECK_FAILED','SEARCH_FAILED','ANALYZE_FAILED','GET_TARGET_METADATA_FAILED','VALIDATE_FAILED','DUPLICATE_CHECK_FAILED','RATE_LIMIT','SUBMIT_FAILED','PARSE_FAILED','OPEN_CREATE_FAILED','GET_TARGETS_FAILED','GET_TARGET_FILES_FAILED','ELICIT_FAILED','RECORD_USAGE_FAILED','CONFIRM_USAGE_FAILED','SET_AUTHORITY_FAILED','RATING_FAILED','CAPABILITIES_FAILED']; const missing=exp.filter(e=>s.indexOf(\"errorCode: '\"+e+\"'\")<0); if(missing.length){console.error('Missing:',missing.join(','));process.exit(1);} console.log('Static error codes OK');"

      - name: Run unit tests
        run: npm run test:unit

      - name: Run integration tests
        run: npm run test:integration
        env:
          ASD_DISABLE_WRITE_GUARD: '1'
          ASD_DISABLE_RATE_LIMIT: '1'
