# ──────────────────────────────────────────────────────
# AutoSnippet V2 CI Pipeline
# 构建 → API 验证 → 单元测试 → 集成测试
# ──────────────────────────────────────────────────────
name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  API_BASE: http://localhost:3100/api/v1
  NODE_ENV: test

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: cd dashboard && npm ci
      - run: npm run build:dashboard

  api-smoke:
    name: API Smoke Test
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: cd dashboard && npm ci
      - run: npm run build:dashboard

      - name: Start API Server
        run: |
          ASD_SKIP_ENTRY_CHECK=1 ASD_DISABLE_WRITE_GUARD=1 ASD_DISABLE_RATE_LIMIT=1 \
            npm run dashboard -- --port 3100 --no-open > /tmp/api-server.log 2>&1 &
          echo "PID=$!" >> $GITHUB_ENV
          sleep 2

      - name: Wait for readiness
        run: |
          for i in $(seq 1 30); do
            if curl -sf $API_BASE/health > /dev/null 2>&1; then
              echo "✓ API ready (${i}s)"
              exit 0
            fi
            sleep 1
          done
          echo "✗ API not ready after 30s"
          cat /tmp/api-server.log
          exit 1

      - name: Health check
        run: |
          HEALTH=$(curl -sf $API_BASE/health)
          echo "$HEALTH" | jq .
          echo "$HEALTH" | jq -e '.status == "healthy"'

      - name: Readiness check
        run: |
          curl -sf $API_BASE/health/ready | jq -e '.ready == true'

      - name: Candidates batch-create
        run: |
          curl -sf -X POST -H 'Content-Type: application/json' \
            -d '{
              "items": [
                { "code": "func retry() async throws -> Data { }", "language": "swift", "category": "networking", "source": "ci" },
                { "code": "[webView loadRequest:req];", "language": "objectivec", "category": "ui", "source": "ci" }
              ]
            }' \
            $API_BASE/candidates/batch-create | jq .

      - name: List candidates
        run: |
          curl -sf $API_BASE/candidates?limit=5 | jq '.success'

      - name: List recipes
        run: |
          curl -sf $API_BASE/recipes?limit=5 | jq '.success'

      - name: Upload server log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: api-server-log
          path: /tmp/api-server.log

  unit-tests:
    name: Unit Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run test:unit

  integration-tests:
    name: Integration Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run test:integration
        env:
          ASD_DISABLE_WRITE_GUARD: '1'
          ASD_DISABLE_RATE_LIMIT: '1'